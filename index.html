<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Low-Bandwidth Video Chat (Multi-User)</title>

  <!-- Tailwind CSS for styling -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Custom styles for the toggle switch */
    .toggle-checkbox:checked {
      @apply: bg-blue-600;
      right: 0;
      border-color: #3b82f6;
    }
    .toggle-checkbox:checked + .toggle-label {
      @apply: bg-blue-600;
    }
  </style>

  <!-- ✅ ADD YOUR FIREBASE CONFIG SNIPPET HERE -->
  <script>
    // Replace with your actual Firebase config (from Firebase Console)
    window.__firebase_config = JSON.stringify({
      apiKey: "AIzaSyA5gHyKnfcfA8HmotGBhR_PQE--HFvb5o",
      authDomain: "web-rtc-3e9c2.firebaseapp.com",
      projectId: "web-rtc-3e9c2",
      storageBucket: "web-rtc-3e9c2.firebasestorage.app",
      messagingSenderId: "452879858277",
      appId: "1:452879858277:web:1c7a9add88bf0e6097648c",
      measurementId: "G-HGQD8P1PNT"
    });
    window.__app_id = "low-bandwidth-demo";
  </script>

  <!-- ✅ Import Firebase SDKs (modular, CDN version) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, onSnapshot, addDoc, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Global Firebase & App Variables ---
    let db, auth, app;
    let userId;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    let localStream;
    let canvasStream;
    let pc; // Single PeerConnection
    let roomRef;
    let offerCandidatesRef;
    let answerCandidatesRef;
    let animationFrameId;

    // --- DOM Elements ---
    const startButton = document.getElementById('startButton');
    const joinButton = document.getElementById('joinButton');
    const roomIdInput = document.getElementById('roomId');
    const lowBandwidthToggle = document.getElementById('lowBandwidthToggle');
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const canvas = document.getElementById('processingCanvas');
    const ctx = canvas.getContext('2d');
    const statusText = document.getElementById('statusText');

    const VIDEO_WIDTH = 400;
    const VIDEO_HEIGHT = 400;
    const CROP_SIZE = 200;
    const CROP_X = (VIDEO_WIDTH - CROP_SIZE) / 2;
    const CROP_Y = (VIDEO_HEIGHT - CROP_SIZE) / 2;

    const rtcConfig = {
      iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
    };

    window.onload = initFirebase;
    startButton.onclick = startCamera;
    joinButton.onclick = joinOrCreateRoom;
    lowBandwidthToggle.onchange = toggleBandwidthMode;

    // --- Initialize Firebase ---
    async function initFirebase() {
      try {
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        setLogLevel('debug');

        onAuthStateChanged(auth, async (user) => {
          if (user) {
            userId = user.uid;
            console.log('Firebase Auth Success. User ID:', userId);
            statusText.textContent = 'Firebase connected. Ready for camera.';
            startButton.disabled = false;
          } else {
            console.log('User is not authenticated. Signing in...');
            if (typeof __initial_auth_token !== 'undefined') {
              await signInWithCustomToken(auth, __initial_auth_token);
            } else {
              await signInAnonymously(auth);
            }
          }
        });
      } catch (e) {
        console.error("Firebase initialization error:", e);
        statusText.textContent = 'Firebase init failed. Check config.';
      }
    }

    async function startCamera() {
      if (!auth.currentUser) {
        statusText.textContent = 'Waiting for Firebase auth...';
        return;
      }
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ 
          video: { width: VIDEO_WIDTH, height: VIDEO_HEIGHT }, 
          audio: true
        });
        localVideo.srcObject = localStream;
        processVideoFrame();

        canvasStream = canvas.captureStream(30);
        localStream.getAudioTracks().forEach(track => canvasStream.addTrack(track));

        startButton.disabled = true;
        joinButton.disabled = false;
        roomIdInput.disabled = false;
        startButton.textContent = 'Camera On';
        startButton.classList.replace('bg-blue-600', 'bg-gray-500');
        statusText.textContent = 'Camera on. Enter a Room ID to join.';
      } catch (e) {
        console.error('Error starting camera:', e);
        statusText.textContent = 'Could not access camera. Please check permissions.';
      }
    }

    function processVideoFrame() {
      if (lowBandwidthToggle.checked) {
        ctx.fillStyle = 'black';
        ctx.fillRect(0, 0, VIDEO_WIDTH, VIDEO_HEIGHT);
        ctx.drawImage(localVideo, CROP_X, CROP_Y, CROP_SIZE, CROP_SIZE, CROP_X, CROP_Y, CROP_SIZE, CROP_SIZE);
      } else {
        ctx.drawImage(localVideo, 0, 0, VIDEO_WIDTH, VIDEO_HEIGHT);
      }
      animationFrameId = requestAnimationFrame(processVideoFrame);
    }

    async function joinOrCreateRoom() {
      const roomId = roomIdInput.value;
      if (!roomId) {
        statusText.textContent = 'Please enter a Room ID.';
        return;
      }
      joinButton.disabled = true;
      statusText.textContent = `Joining room: ${roomId}...`;

      const roomCollectionPath = `artifacts/${appId}/public/data/webrtc-rooms`;
      roomRef = doc(db, roomCollectionPath, roomId);
      offerCandidatesRef = collection(roomRef, 'offerCandidates');
      answerCandidatesRef = collection(roomRef, 'answerCandidates');

      pc = new RTCPeerConnection(rtcConfig);
      canvasStream.getTracks().forEach(track => pc.addTrack(track, canvasStream));

      pc.ontrack = e => {
        if (e.streams && e.streams[0]) remoteVideo.srcObject = e.streams[0];
      };

      pc.onicecandidate = async e => {
        if (e.candidate) {
          const docSnap = await getDoc(roomRef);
          if (docSnap.exists() && docSnap.data().answer) {
            await addDoc(answerCandidatesRef, e.candidate.toJSON());
          } else {
            await addDoc(offerCandidatesRef, e.candidate.toJSON());
          }
        }
      };

      const roomDoc = await getDoc(roomRef);
      if (!roomDoc.exists() || !roomDoc.data().offer) {
        statusText.textContent = 'Creating new room...';
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        await setDoc(roomRef, { offer: { type: offer.type, sdp: offer.sdp } });
        onSnapshot(roomRef, async (doc) => {
          const data = doc.data();
          if (data && data.answer && !pc.currentRemoteDescription) {
            const answer = new RTCSessionDescription(data.answer);
            await pc.setRemoteDescription(answer);
            statusText.textContent = 'Peer connected!';
          }
        });
        onSnapshot(answerCandidatesRef, (snapshot) => {
          snapshot.docChanges().forEach((change) => {
            if (change.type === 'added') pc.addIceCandidate(new RTCIceCandidate(change.doc.data()));
          });
        });
      } else {
        statusText.textContent = 'Joining existing room...';
        const offer = roomDoc.data().offer;
        await pc.setRemoteDescription(new RTCSessionDescription(offer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        await updateDoc(roomRef, { answer: { type: answer.type, sdp: answer.sdp } });
        onSnapshot(offerCandidatesRef, (snapshot) => {
          snapshot.docChanges().forEach((change) => {
            if (change.type === 'added') pc.addIceCandidate(new RTCIceCandidate(change.doc.data()));
          });
        });
      }

      joinButton.textContent = 'In Call';
      statusText.textContent = 'WebRTC Handshake in progress...';
    }

    function toggleBandwidthMode() {
      if (lowBandwidthToggle.checked) {
        console.log('Low Bandwidth Mode: ON');
        remoteVideo.classList.add('border-blue-500');
      } else {
        console.log('Low Bandwidth Mode: OFF');
        remoteVideo.classList.remove('border-blue-500');
      }
    }
  </script>
</head>

<body class="bg-gray-900 text-gray-100 font-sans antialiased min-h-screen flex flex-col items-center justify-center p-4">
  <div class="max-w-5xl w-full p-6 bg-gray-800 rounded-2xl shadow-xl">
    <h1 class="text-3xl font-bold text-center text-blue-400 mb-2">Low-Bandwidth Video Chat (Multi-User)</h1>
    <p id="statusText" class="text-center text-gray-400 mb-6">Connecting to Firebase...</p>

    <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-6 p-4 bg-gray-700 rounded-lg">
      <button id="startButton" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-all duration-200 shadow-md" disabled>1. Start Camera</button>
      <input type="text" id="roomId" placeholder="Enter Room ID" class="text-gray-900 text-center font-medium p-3 rounded-lg w-full sm:w-auto" disabled>
      <button id="joinButton" class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-all duration-200 shadow-md" disabled>2. Join Room</button>

      <div class="flex items-center justify-center gap-3 ml-0 sm:ml-6 mt-4 sm:mt-0">
        <div class="relative inline-block w-14 align-middle select-none transition duration-200 ease-in">
          <input type="checkbox" name="toggle" id="lowBandwidthToggle" class="toggle-checkbox absolute block w-7 h-7 rounded-full bg-white border-4 appearance-none cursor-pointer top-0.5 left-0.5 transition-all duration-300 ease-in-out" />
          <label for="lowBandwidthToggle" class="toggle-label block overflow-hidden h-8 rounded-full bg-gray-500 cursor-pointer"></label>
        </div>
        <label for="lowBandwidthToggle" class="text-lg font-medium text-white">Low Bandwidth Mode</label>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-gray-700 p-4 rounded-lg shadow-inner">
        <h2 class="text-xl font-semibold text-center mb-3">Your Camera (Full 400x400)</h2>
        <video id="localVideo" autoplay playsinline muted class="w-[400px] h-[400px] mx-auto bg-black rounded-md border-2 border-gray-600"></video>
      </div>

      <div class="bg-gray-700 p-4 rounded-lg shadow-inner">
        <h2 class="text-xl font-semibold text-center mb-3">Remote Video (Processed)</h2>
        <video id="remoteVideo" autoplay playsinline class="w-[400px] h-[400px] mx-auto bg-black rounded-md border-2 border-gray-600"></video>
      </div>
    </div>

    <canvas id="processingCanvas" width="400" height="400" class="hidden"></canvas>
  </div>
</body>
</html>
